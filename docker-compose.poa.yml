# GridTokenX PoA (Proof of Authority) Cluster
# 3-validator setup for production-grade benchmarking
#
# Usage:
#   docker-compose -f docker-compose.poa.yml up -d
#   pnpm test:tpc-benchmark  # Run against cluster
#
# Architecture:
#   - bootstrap: Genesis validator (leader)
#   - validator1: Secondary validator
#   - validator2: Secondary validator
#   - rpc: RPC node for client connections

services:
  # Bootstrap/Genesis Validator (Leader)
  bootstrap:
    build:
      context: .
      dockerfile: Dockerfile.validator
    container_name: gridtokenx-bootstrap
    hostname: bootstrap
    environment:
      - RUST_LOG=solana_runtime::message_processor=info
      - VALIDATOR_TYPE=bootstrap
      - EXPECTED_GENESIS_HASH=auto
      - IDENTITY_KEYPAIR=/keys/bootstrap-identity.json
      - VOTE_ACCOUNT_KEYPAIR=/keys/bootstrap-vote.json
      - LEDGER_DIR=/data/ledger
      - GOSSIP_PORT=8001
      - RPC_PORT=8899
      - SLOTS_PER_EPOCH=32
      - TICKS_PER_SLOT=64
      - HASHES_PER_TICK=auto
    volumes:
      - bootstrap_ledger:/data/ledger
      - ./keypairs/poa:/keys:ro
    ports:
      - "8001:8001/udp"  # Gossip
      - "8899:8899"      # RPC (primary)
      - "8900:8900"      # WebSocket
    networks:
      poa-network:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD", "solana", "cluster-version", "-u", "http://localhost:8899"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Validator 1
  validator1:
    build:
      context: .
      dockerfile: Dockerfile.validator
    container_name: gridtokenx-validator1
    hostname: validator1
    depends_on:
      bootstrap:
        condition: service_healthy
    environment:
      - RUST_LOG=solana_runtime::message_processor=info
      - VALIDATOR_TYPE=secondary
      - ENTRYPOINT=bootstrap:8001
      - IDENTITY_KEYPAIR=/keys/validator1-identity.json
      - VOTE_ACCOUNT_KEYPAIR=/keys/validator1-vote.json
      - LEDGER_DIR=/data/ledger
      - GOSSIP_PORT=8001
      - RPC_PORT=8899
    volumes:
      - validator1_ledger:/data/ledger
      - ./keypairs/poa:/keys:ro
    ports:
      - "8101:8001/udp"
      - "8199:8899"
    networks:
      poa-network:
        ipv4_address: 172.28.0.11
    healthcheck:
      test: ["CMD", "solana", "cluster-version", "-u", "http://localhost:8899"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Validator 2
  validator2:
    build:
      context: .
      dockerfile: Dockerfile.validator
    container_name: gridtokenx-validator2
    hostname: validator2
    depends_on:
      bootstrap:
        condition: service_healthy
    environment:
      - RUST_LOG=solana_runtime::message_processor=info
      - VALIDATOR_TYPE=secondary
      - ENTRYPOINT=bootstrap:8001
      - IDENTITY_KEYPAIR=/keys/validator2-identity.json
      - VOTE_ACCOUNT_KEYPAIR=/keys/validator2-vote.json
      - LEDGER_DIR=/data/ledger
      - GOSSIP_PORT=8001
      - RPC_PORT=8899
    volumes:
      - validator2_ledger:/data/ledger
      - ./keypairs/poa:/keys:ro
    ports:
      - "8201:8001/udp"
      - "8299:8899"
    networks:
      poa-network:
        ipv4_address: 172.28.0.12
    healthcheck:
      test: ["CMD", "solana", "cluster-version", "-u", "http://localhost:8899"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Dedicated RPC Node (no voting, optimized for queries)
  rpc:
    build:
      context: .
      dockerfile: Dockerfile.validator
    container_name: gridtokenx-rpc
    hostname: rpc
    depends_on:
      bootstrap:
        condition: service_healthy
    environment:
      - RUST_LOG=solana_runtime::message_processor=info
      - VALIDATOR_TYPE=rpc
      - ENTRYPOINT=bootstrap:8001
      - IDENTITY_KEYPAIR=/keys/rpc-identity.json
      - LEDGER_DIR=/data/ledger
      - RPC_PORT=8899
      - NO_VOTING=true
      - FULL_RPC_API=true
      - ENABLE_RPC_TRANSACTION_HISTORY=true
    volumes:
      - rpc_ledger:/data/ledger
      - ./keypairs/poa:/keys:ro
    ports:
      - "8399:8899"      # Alternative RPC
      - "8400:8900"      # Alternative WebSocket
    networks:
      poa-network:
        ipv4_address: 172.28.0.20
    healthcheck:
      test: ["CMD", "solana", "cluster-version", "-u", "http://localhost:8899"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

volumes:
  bootstrap_ledger:
  validator1_ledger:
  validator2_ledger:
  rpc_ledger:

networks:
  poa-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
